import javax.swing.*;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.awt.event.*;
import java.awt.geom.RoundRectangle2D;
import java.util.ArrayList;
import java.util.List;

public class ParkUI extends JFrame {

    // ===== RENK PALETİ (DOKUNULMADI) =====
    private final Color COLOR_BG = new Color(30, 35, 45);
    private final Color COLOR_ROAD = new Color(55, 60, 70);
    private final Color COLOR_ROAD_LINE = new Color(240, 190, 50);

    private final Color STATE_EMPTY = new Color(46, 213, 115);
    private final Color STATE_RESERVED = new Color(255, 200, 50);
    private final Color STATE_OCCUPIED = new Color(255, 71, 87);
    private final Color STATE_SELECTED = new Color(55, 66, 250);

    private ParkingSlotButton currentSelectedSlot = null;
    private final List<ParkingSlotButton> allSlots = new ArrayList<>();

    private final String loggedInPlaka;
    private final ParkDAO dao = new ParkDAO();

    // ===== CONSTRUCTOR =====
    public ParkUI(String plaka) {
        this.loggedInPlaka = plaka;

        setTitle("39 PARK | Park Seçimi");
        setSize(1000, 700);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout());
        getContentPane().setBackground(COLOR_BG);

        add(createHeader(), BorderLayout.NORTH);
        add(createMainContent(), BorderLayout.CENTER);
        add(createControlPanel(), BorderLayout.SOUTH);

        loadSlotsFromDB();
    }

    // ===== HEADER =====
    private JPanel createHeader() {
        JPanel header = new JPanel(new FlowLayout(FlowLayout.LEFT, 30, 20));
        header.setOpaque(false);

        JLabel title = new JLabel("39 PARK");
        title.setFont(new Font("Segoe UI", Font.BOLD, 32));
        title.setForeground(Color.WHITE);

        JLabel sub = new JLabel(" | Hoş geldin, " + loggedInPlaka);
        sub.setFont(new Font("Segoe UI", Font.PLAIN, 18));
        sub.setForeground(new Color(150, 150, 160));

        header.add(title);
        header.add(sub);
        return header;
    }

    // ===== ORTA ALAN =====
    private JPanel createMainContent() {
        JPanel main = new JPanel(new GridBagLayout());
        main.setOpaque(false);
        main.setBorder(new EmptyBorder(20, 20, 20, 20));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.fill = GridBagConstraints.BOTH;
        gbc.insets = new Insets(10, 10, 10, 10);

        gbc.gridx = 0; gbc.weightx = 0.4;
        main.add(createParkingBlock(1, 4), gbc);

        gbc.gridx = 1; gbc.weightx = 0.2;
        main.add(createRoadPanel(), gbc);

        gbc.gridx = 2; gbc.weightx = 0.4;
        main.add(createParkingBlock(5, 8), gbc);

        return main;
    }

    private JPanel createParkingBlock(int start, int end) {
        JPanel panel = new JPanel(new GridLayout(0, 1, 15, 15));
        panel.setOpaque(false);

        for (int i = start; i <= end; i++) {
            ParkingSlotButton b = new ParkingSlotButton("P-" + i);
            allSlots.add(b);
            b.addActionListener(e -> handleSlotSelection(b));
            panel.add(b);
        }
        return panel;
    }

    private JPanel createRoadPanel() {
        return new JPanel() {
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2 = (Graphics2D) g;
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

                g2.setColor(COLOR_ROAD);
                g2.fillRect(0, 0, getWidth(), getHeight());

                g2.setColor(COLOR_ROAD_LINE);
                Stroke dashed = new BasicStroke(
                        4, BasicStroke.CAP_BUTT,
                        BasicStroke.JOIN_BEVEL,
                        0, new float[]{20, 30}, 0
                );
                g2.setStroke(dashed);
                g2.drawLine(getWidth() / 2, 0, getWidth() / 2, getHeight());

                g2.setStroke(new BasicStroke(2));
                g2.setColor(Color.LIGHT_GRAY);
                g2.drawLine(5, 0, 5, getHeight());
                g2.drawLine(getWidth() - 5, 0, getWidth() - 5, getHeight());
            }
        };
    }

    // ===== ALT PANEL =====
    private JPanel createControlPanel() {
        JPanel panel = new JPanel(new FlowLayout(FlowLayout.CENTER, 25, 25));
        panel.setBackground(new Color(40, 45, 55));
        panel.setPreferredSize(new Dimension(0, 100));

        JLabel lbl = new JLabel("Süre Seç:");
        lbl.setForeground(Color.WHITE);

        JComboBox<String> cmb = new JComboBox<>(new String[]{
                "1 Saat", "2 Saat", "4 Saat", "6 Saat", "8 Saat", "12 Saat", "Tüm Gün"
        });

        ModernActionButton reserve = new ModernActionButton("Rezerve Et", STATE_RESERVED);
        reserve.addActionListener(e -> processAction(SlotStatus.RESERVED));

        ModernActionButton occupy = new ModernActionButton("Yeri Ayır", STATE_OCCUPIED);
        occupy.addActionListener(e -> processAction(SlotStatus.OCCUPIED));

        JButton clear = new JButton("Seçimi Geri Al");
        clear.addActionListener(e -> processAction(SlotStatus.EMPTY));

        panel.add(lbl);
        panel.add(cmb);
        panel.add(reserve);
        panel.add(occupy);
        panel.add(clear);

        return panel;
    }

    // ===== LOGIC =====
    private void handleSlotSelection(ParkingSlotButton b) {
        if (currentSelectedSlot != null) {
            currentSelectedSlot.setSlotSelected(false);
        }
        currentSelectedSlot = b;
        b.setSlotSelected(true);
    }

    private void processAction(SlotStatus status) {
        if (currentSelectedSlot == null) {
            JOptionPane.showMessageDialog(this, "Lütfen park yeri seçin");
            return;
        }

        if (currentSelectedSlot.getStatus() != SlotStatus.EMPTY) {
            JOptionPane.showMessageDialog(this, "Bu park yeri dolu!");
            return;
        }

        boolean ok = dao.updateSlot(
                currentSelectedSlot.label,
                status.name(),
                loggedInPlaka
        );

        if (ok) {
            currentSelectedSlot.setStatus(status);
            currentSelectedSlot.setSlotSelected(false);
            currentSelectedSlot = null;
        }
    }

    private void loadSlotsFromDB() {
        for (ParkSlot s : dao.getAllSlots()) {
            for (ParkingSlotButton b : allSlots) {
                if (b.label.equals(s.getParkKodu())) {
                    b.setStatus(SlotStatus.valueOf(s.getDurum()));
                }
            }
        }
    }

    // ===== INNER TYPES =====
    private enum SlotStatus { EMPTY, RESERVED, OCCUPIED }

    private class ParkingSlotButton extends JButton {
        private SlotStatus status = SlotStatus.EMPTY;
        private boolean selected = false;
        private final String label;

        ParkingSlotButton(String l) {
            label = l;
            setContentAreaFilled(false);
            setFocusPainted(false);
            setBorderPainted(false);
            setCursor(new Cursor(Cursor.HAND_CURSOR));
            setPreferredSize(new Dimension(140, 70));
        }

        SlotStatus getStatus() {
            return status;
        }

        void setStatus(SlotStatus s) {
            status = s;
            repaint();
        }

        void setSlotSelected(boolean s) {
            selected = s;
            repaint();
        }

        protected void paintComponent(Graphics g) {
            Graphics2D g2 = (Graphics2D) g;
            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

            Color c = selected ? STATE_SELECTED :
                    status == SlotStatus.RESERVED ? STATE_RESERVED :
                            status == SlotStatus.OCCUPIED ? STATE_OCCUPIED :
                                    STATE_EMPTY;

            g2.setColor(c);
            g2.fill(new RoundRectangle2D.Float(
                    5, 5,
                    getWidth() - 10, getHeight() - 10,
                    20, 20
            ));

            g2.setColor(Color.WHITE);
            g2.setFont(new Font("Segoe UI", Font.BOLD, 18));
            FontMetrics fm = g2.getFontMetrics();
            g2.drawString(label,
                    (getWidth() - fm.stringWidth(label)) / 2,
                    (getHeight() + fm.getAscent()) / 2 - 5);
        }
    }

    private class ModernActionButton extends JButton {
        private final Color base;

        ModernActionButton(String t, Color c) {
            super(t);
            base = c;
            setContentAreaFilled(false);
            setFocusPainted(false);
            setBorderPainted(false);
            setForeground(Color.WHITE);
            setCursor(new Cursor(Cursor.HAND_CURSOR));
            setPreferredSize(new Dimension(130, 45));
        }

        protected void paintComponent(Graphics g) {
            Graphics2D g2 = (Graphics2D) g;
            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
            g2.setColor(getModel().isPressed() ? base.darker() : base);
            g2.fill(new RoundRectangle2D.Float(0, 0, getWidth(), getHeight(), 15, 15));
            g2.setColor(Color.WHITE);
            FontMetrics fm = g2.getFontMetrics();
            g2.drawString(getText(),
                    (getWidth() - fm.stringWidth(getText())) / 2,
                    (getHeight() + fm.getAscent()) / 2 - 2);
        }
    }
}
